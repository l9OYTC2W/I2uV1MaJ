function cs_spm_print(fileName)
% Use spm print function

global defaults;

% Store old value
uiPrint = defaults.ui.print;

[pathstr, fName, extn] = fileparts(fileName);

if isempty(pathstr)
    pathstr = pwd;
end


%% Capture frame (Fix Aspect ratio of images on matlab -nodisplay)
isMatlabNodisplay = 0;
if (isunix)
    try
        captured_frame = getframe(gcf);
    catch
        captured_frame.cdata = [];
        isMatlabNodisplay = 1;
    end
end

if (strcmpi(extn, '.jpg') || strcmpi(extn, '.jpeg')) && (~isMatlabNodisplay)
    % JPEG file
    defaults.ui.print   = struct('opt', {{'-djpeg', '-append'}},'append', true, ...
        'ext', '.jpg');
else
    % Postscript file
    defaults.ui.print   = struct('opt', {{'-dpsc2', '-append'}}, 'append', true, ...
        'ext', '.ps');
end

if exist('fileName', 'var')
    spm_print(fileName);
    if (isMatlabNodisplay)
        newFileName = fullfile(pathstr, [fName, extn]);
        figPos = get(gcf, 'DefaultFigureposition');
        img_resolution(1) = 1100;
        img_resolution(2) = img_resolution(1)/(figPos(3)/figPos(4));
        img_resolution_str = [num2str(img_resolution(1)), 'x', num2str(img_resolution(2))];
        print_commands = ['gs -q -dNOPAUSE -dBATCH -sDEVICE=jpeg -r144 -sOutputFile=', jpg_file_name, ' ', ps_file_name, ...
            '; convert ', jpg_file_name, ' -depth 16 -resize ', img_resolution_str, '\! ', jpg_file_name];
        system(print_commands);
    end
else
    spm_print;
end

% Assign old value
defaults.ui.print = uiPrint;
